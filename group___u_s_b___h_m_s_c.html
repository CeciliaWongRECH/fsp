<!-- HTML header for doxygen 1.8.7-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<title>RA Flexible Software Package Documentation: Host Mass Storage Class Driver (r_usb_hmsc)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="fsp_customdoxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_scaled.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">RA Flexible Software Package Documentation
   &#160;<span id="projectnumber">Release v0.8.0</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group___u_s_b___h_m_s_c.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Host Mass Storage Class Driver (r_usb_hmsc)<div class="ingroups"><a class="el" href="group___r_e_n_e_s_a_s___m_o_d_u_l_e_s.html">Modules</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<p>The USB module (r_usb_hmsc) provides an API to perform hardware control of USB communications. It implements the <a class="el" href="group___u_s_b___a_p_i.html">USB Interface</a>. </p>
<p>This module is USB Basic Host and Peripheral. It works in combination with Driver (r_usb_basic module).</p>
<h1><a class="anchor" id="r-usb_hmsc-overview"></a>
Overview</h1>
<p>The r_usb_hmsc module, when used in combination with the r_usb_basic module, operates as a USB host mass storage class driver (HMSC). HMSC is built on the USB mass storage class Bulk-Only Transport (BOT) protocol. It is possible to communicate with BOT-compatible USB storage devices by combining it with the file system and storage device driver. This module should be used in combination with the FreeRTOS+FAT File System.</p>
<h2><a class="anchor" id="r-usb_hmsc-features"></a>
Features</h2>
<p>The r_usb_hmsc module has the following key features:</p>
<ul>
<li>Checking of connected USB storage devices (to determine whether or not operation is supported)</li>
<li>Storage command communication using the BOT protocol</li>
<li>Support for SFF-8070i (ATAPI) USB mass storage subclass</li>
<li>Sharing of a single pipe for IN/OUT directions or multiple devices</li>
<li>Maximum 4 USB storage devices can be connected</li>
</ul>
<h3>Class Driver Overview</h3>
<p><b>1. Class Requests</b></p>
<p>The class requests supported by this driver are shown below.</p>
<table class="doxtable">
<tr>
<th align="left">Request </th><th align="left">Description  </th></tr>
<tr>
<td align="left">GetMaxLun </td><td align="left">Gets the maximum number of units that are supported. </td></tr>
<tr>
<td align="left">MassStrageReset </td><td align="left">Cancels a protocol error. </td></tr>
</table>
<p><b>2. Storage Commands</b></p>
<p>This driver supports the following storage command.</p>
<ul>
<li>TEST_UNIT_READY</li>
<li>REQUEST_SENSE</li>
<li>MODE_SELECT10</li>
<li>MODE_SENSE10</li>
<li>PREVENT_ALLOW</li>
<li>READ_FORMAT_CAPACITY</li>
<li>READ10</li>
<li>WRITE10</li>
</ul>
<h1><a class="anchor" id="r-usb_hmsc-configuration"></a>
Configuration</h1>
<h2><a class="anchor" id="r-usb_hmsc-clock-configuration"></a>
Clock Configuration</h2>
<p>Refer to <a class="el" href="group___u_s_b.html">Universal Serial Bus (r_usb_basic)</a> basic module.</p>
<h2><a class="anchor" id="r-usb_hmsc-pin-configuration"></a>
Pin Configuration</h2>
<p>Refer to <a class="el" href="group___u_s_b.html">Universal Serial Bus (r_usb_basic)</a> basic module.</p>
<h1><a class="anchor" id="r-usb_hmsc-usage_notes"></a>
Usage Notes</h1>
<ul>
<li>This driver is not guaranteed to provide USB communication operation. The customer should verify operation when utilizing it in a system and confirm the ability to connect to a variety of different types of devices.</li>
<li>This module must be incorporated into a project using r_usb_basic. Once incorporated into a project, use the API to perform USB hardware control.</li>
<li>This driver is confirmed for operation in combination with the FreeRTOS+FAT File System.</li>
</ul>
<h2><a class="anchor" id="r-usb_hmsc-limitations"></a>
Limitations</h2>
<ol type="1">
<li>Some MSC devices may be unable to connect (because they are not recognized as storage devices).</li>
<li>MSC devices that return values of 1 or higher in response to the GetMaxLun command (mass storage class command) are not supported.</li>
<li>Maximum 4 USB storage devices can be connected.</li>
<li>USB storage devices with a sector size of 512 bytes can be connected.</li>
<li>A device that does not respond to the READ_CAPACITY command operates as a device with a sector size of 512 bytes.</li>
</ol>
<h1><a class="anchor" id="r-usb_hmsc-examples"></a>
Examples</h1>
<h2>USB HMSC Example</h2>
<p><b>Example Operating Environment</b></p>
<p>The following shows an example operating environment for the HMSC.</p>
<p>Refer to the associated instruction manuals for details on setting up the evaluation board and using the emulator, etc.</p>
<div class="image">
<img src="r_usb_hmsc_operating_environment.png" alt="r_usb_hmsc_operating_environment.png"/>
<div class="caption">
Example Operating Environment</div></div>
 <h3>Application Specifications</h3>
<p>The main functions of the application are as follows:</p>
<ol type="1">
<li>Performs enumeration and drive recognition processing on MSC devices.</li>
<li>After the above processsing finisihes, the application writes the file <code>hmscdemo.txt</code> to the MSC device once.</li>
<li>After writing the above file, the APL repeatedly reads the file <code>hmscdemo.txt</code>. It continues to read the file repeatedly until the switch is pressed again.</li>
</ol>
<h3>Application Processing (for RTOS)</h3>
<p>This application has two tasks. An overview of the processing in these two tasks is provided below.</p>
<p><b>usb_apl_task</b></p>
<ol type="1">
<li>After start up, MCU pin setting, USB controller initialization, and application program initialization are performed.</li>
<li>The MSC device is attached to the kit. When enumeration and drive recognition processing have completed, the USB driver calls the callback function (usb_apl_callback). In the callback function (usb_apl_callback), the application task is notified of the USB completion event using the FreeRTOS functionality.</li>
<li>In the application task, information regarding the USB completion event about which notification was received from the callback function is retrieved using the real-time OS functionality.</li>
<li>If the USB completion event (the event member of the usb_ctrl_t structure) retrieved in step 2 above is USB_STS_CONFIGURED then, based on the USB completion event, the MSC device is mounted and the file is written to the MSC device.</li>
<li>If the USB completion event (the event member of the usb_ctrl_t structure) retrieved in step 2 above is USB_STS_DETACH, the application initializes the variables for state management.</li>
</ol>
<div class="image">
<img src="r_usb_hmsc_task_flow_sample.png" alt="r_usb_hmsc_task_flow_sample.png"/>
<div class="caption">
usb_apl_task</div></div>
<p> <b>file_read_task</b></p>
<p>Of the application tasks usb_apl_task and file_read_task, file_read_task is processed while usb_apl_task is in the wait state. This task performs file read processing on the file that was written to the MSC device (<code>hmscdemo.txt</code>).</p>
<p>This is an hmsc example of minimal use of the USB in an application.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> usb_hmsc_example (<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___u_s_b.html#structusb__instance__ctrl__t">usb_instance_ctrl_t</a> ctrl;</div><div class="line">    usb_instance_transfer_t trans;</div><div class="line">    usb_instance_transfer_t *p_mess;</div><div class="line">    uint8_t g_buf[USB_VALUE_64];</div><div class="line">    capacity_list_t *pcl;</div><div class="line">    FF_Disk_t *USB_ret = NULL;</div><div class="line">    <span class="keywordtype">size_t</span> size_return;</div><div class="line">    <span class="keywordtype">int</span> close_err;</div><div class="line"></div><div class="line">    apl_init();</div><div class="line"></div><div class="line">    usb_pin_setting();  <span class="comment">/* USB pin function and port mode setting. */</span></div><div class="line"></div><div class="line">    trans.module_number = <a class="code" href="group___u_s_b___a_p_i.html#gaa2977e7b1636fce1d93b20bb0c986d89">USB_IP0</a>;</div><div class="line">    trans.type = <a class="code" href="group___u_s_b___a_p_i.html#ggab1dc4a2240edf1a50cca3945f31dc9f2afd9d59bc253fddb8b37cb089fc7f4e62">USB_CLASS_HMSC</a>;</div><div class="line">    g_usb_on_usb.<a class="code" href="group___u_s_b___a_p_i.html#aefa767fa78b481c328020e9b1a9b5812">open</a>(&amp;ctrl, &amp;g_usb0_cfg, &amp;trans);</div><div class="line"></div><div class="line">    g_usb0_cfg.p_usb_apl_callback = &amp;usb_apl_callback;</div><div class="line">    R_USB_Callback(g_usb0_cfg.p_usb_apl_callback);</div><div class="line">    usb_configured = 0;</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (1)</div><div class="line">    {</div><div class="line">        USB_APL_RCV_MSG(USB_APL_MBX, (usb_msg_t **)&amp;p_mess);</div><div class="line">        trans = *p_mess;</div><div class="line"></div><div class="line">        <span class="keywordflow">switch</span> (trans.event)</div><div class="line">        {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___u_s_b___a_p_i.html#gga56bea25fbffdbda134044c49d40d5e40ab5c3bd23fe62533150eef3a4e8c8d13c">USB_STATUS_CONFIGURED</a> :</div><div class="line">            g_buf[0] = USB_VALUE_3FH; <span class="comment">/* Page Code */</span></div><div class="line"></div><div class="line">            g_hmsc_on_usb.strgcmd(&amp;ctrl, g_buf, <a class="code" href="group___u_s_b___h_m_s_c___a_p_i.html#ggac5b28f1be9ca57fc904f9c93266a594da2bcce7b971b807b8baeb3ccf546643fc">USB_ATAPI_READ_FORMAT_CAPACITY</a>, &amp;trans);</div><div class="line"></div><div class="line">            pcl = (capacity_list_t *)g_buf;</div><div class="line">            <span class="keywordflow">if</span>(pcl-&gt;current_capacity_header.descriptor_code == 0x02)</div><div class="line">            {</div><div class="line">                usb_device_capacity_blocks = \</div><div class="line">                        ((uint32_t)pcl-&gt;current_capacity_header.number_of_blocks[0] &lt;&lt; 24) | \</div><div class="line">                        ((uint32_t)pcl-&gt;current_capacity_header.number_of_blocks[1] &lt;&lt; 16) | \</div><div class="line">                        ((uint32_t)pcl-&gt;current_capacity_header.number_of_blocks[2] &lt;&lt; 8) | \</div><div class="line">                        ((uint32_t)pcl-&gt;current_capacity_header.number_of_blocks[3]);</div><div class="line"></div><div class="line">                usb_configured = 1;</div><div class="line">            }</div><div class="line"></div><div class="line">            USB_ret = FF_DiskInit( (<span class="keywordtype">char</span>*)main_USB_DISK_NAME, &amp;disk_info);</div><div class="line">            <span class="keywordflow">if</span>(NULL == USB_ret)</div><div class="line">            {</div><div class="line">                printf(<span class="stringliteral">&quot;File Init Fail&quot;</span>);</div><div class="line">            }</div><div class="line"></div><div class="line">            R_USB_HmscSemGet();</div><div class="line"></div><div class="line">            <span class="comment">/* Open the source file in read only mode. */</span></div><div class="line">            pxSourceFile = ff_fopen((<span class="keyword">const</span> <span class="keywordtype">char</span> *)<span class="stringliteral">&quot;TEST_USB.txt&quot;</span>, (<span class="keyword">const</span> <span class="keywordtype">char</span> *)<span class="stringliteral">&quot;w&quot;</span>);</div><div class="line">            <span class="keywordflow">if</span>(0 != pxSourceFile)</div><div class="line">            {</div><div class="line">                <span class="comment">/* Write however many bytes were read from the source file into the destination file. */</span></div><div class="line">                size_return = ff_fwrite( g_file_data, <span class="keyword">sizeof</span>(g_file_data), 1, pxSourceFile );</div><div class="line">                <span class="keywordflow">if</span>(1 == size_return)</div><div class="line">                {</div><div class="line">                    g_isFileWrite = USB_APL_YES;</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                    printf(<span class="stringliteral">&quot;File Write Fail&quot;</span>);</div><div class="line">                }</div><div class="line"></div><div class="line">                close_err = ff_fclose( pxSourceFile );</div><div class="line">                <span class="keywordflow">if</span>(0 != close_err)</div><div class="line">                {</div><div class="line">                    printf(<span class="stringliteral">&quot;File Close Fail&quot;</span>);</div><div class="line">                }</div><div class="line"></div><div class="line">            }</div><div class="line"></div><div class="line">            R_USB_HmscSemRel();</div><div class="line"></div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___u_s_b___a_p_i.html#gga56bea25fbffdbda134044c49d40d5e40ae9bcf94bdb90960ca692b1dfecb98e78">USB_STATUS_DETACH</a> :</div><div class="line">            g_isFileWrite = USB_APL_NO;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        default :</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        } <span class="comment">/* switch( event ) */</span></div><div class="line">    } <span class="comment">/* while(1) */</span></div><div class="line">} <span class="comment">/* End of function usb_hmsc_example() */</span></div><div class="line"></div></div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.7-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
        <li class="footer">FSP v0.8.0 User's Manual Rev0.80 R11UM0137EU0080 Copyright © (2019) Renesas Electronics Corporation. All Rights Reserved.</li>
    <li class="footer">Generated by FSP v0.8.0
    </li>
  </ul>
</div>
</body>
</html>
