<!-- HTML header for doxygen 1.8.7-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<title>RA Flexible Software Package Documentation: AWS MQTT</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="fsp_customdoxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo_scaled.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">RA Flexible Software Package Documentation
   &#160;<span id="projectnumber">Release v2.4.0</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group___a_w_s___m_q_t_t.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">AWS MQTT<div class="ingroups"><a class="el" href="group___r_e_n_e_s_a_s___m_o_d_u_l_e_s.html">Modules</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<p>This module provides the AWS MQTT integration documentation. </p>
<h1><a class="anchor" id="r-AWS_MQTT-overview"></a>
Overview</h1>
<p>The AWS MQTT library can connect to either AWS or a third party MQTT broker such as <a href="https://mosquitto.org/">Mosquitto</a>. The documentation for the library can be found on the <a href="https://docs.aws.amazon.com/freertos/latest/lib-ref/c-sdk/mqtt/index.html">AWS IoT Device SDK C: MQTT</a> website.</p>
<h2><a class="anchor" id="r-AWS_MQTT-features"></a>
Features</h2>
<ul>
<li>MQTT connections over TLS to an AWS IoT Endpoint or Mosquitto server</li>
<li>Unsecure MQTT connections to Mosquitto servers. This is not recommended for production and should only be done to a local server for testiing.</li>
</ul>
<h1><a class="anchor" id="r-AWS_MQTT-configuration"></a>
Configuration</h1>
<h2>Memory Usage</h2>
<p>The AWS MQTT library relies heavily on dynamic memory allocation for thread/task creation as well as other uses. Depending on the configuration it may be required to provde as much as 110k heap. To decrease this it is recommended to tweak the thread stack configuration values based on usage. Noteable values are:</p>
<h3>AWS IoT Common</h3>
<ul>
<li>IoT Thread Default Stack Size</li>
<li>IoT Network Receive Task Stack Size</li>
</ul>
<h3>FreeRTOS Thread</h3>
<ul>
<li>General|Minimal Stack Size</li>
</ul>
<h3>FreeRTOS Plus TCP</h3>
<ul>
<li>Stack size in words (not bytes)</li>
</ul>
<h1><a class="anchor" id="r-AWS_MQTT-usage-notes"></a>
Usage Notes</h1>
<p>The AWS MQTT library utilizes a system taskpool to queue up messages. This system task pool must be created before calling into the MQTT library. iot_init.c has been provided for easy initialization of this taskpool via IotSdk_Init().</p>
<p>The AWS MQTT Demo has been provided to easily demonstrate MQTT functionality. An example of initializiing the system taskpool and running the MQTT demo has been provided below.</p>
<h2><a class="anchor" id="r-AWS_MQTT-limiitations"></a>
Limitations</h2>
<ul>
<li>aws_clientcredential.h and aws_clientcredential_keys.h need to be added manually.</li>
<li>The IoT Thread must have a higher priorty than the Network Receive Thread.</li>
<li>MbedTLS must be initialized and key provisioning must be done before starting a secure connection. Refer to <a class="el" href="group___a_w_s___s_e_c_u_r_e___s_o_c_k_e_t_s.html">AWS Secure Sockets</a>.</li>
</ul>
<h2><a class="anchor" id="r-AWS_MQTT-examples"></a>
Examples</h2>
<h3>Non-secure connection to a Mosquitto server</h3>
<div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#define IOT_LOG_STACK_SIZE                    (256)</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> uint8_t g_ip_address[4]      = {169, 254, 57, 49};</div><div class="line"><span class="keyword">const</span> uint8_t g_net_mask[4]        = {255, 255, 0, 0};</div><div class="line"><span class="keyword">const</span> uint8_t g_gateway_address[4] = {169, 254, 57, 49};</div><div class="line"><span class="keyword">const</span> uint8_t g_dns_address[4]     = {8, 8, 8, 8};</div><div class="line"><span class="keyword">const</span> uint8_t g_mac_address[6]     = {0x66, 0x66, 0x66, 0x66, 0x66, 0x66};</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> mqtt_non_secure_example ()</div><div class="line">{</div><div class="line">    <span class="keywordtype">bool</span> connect_to_aws = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize the crypto hardware acceleration. */</span></div><div class="line">    <a class="code" href="group___r_m___p_s_a___c_r_y_p_t_o.html#gaf0f37c11be234650bec95ce37e9a4a6b">mbedtls_platform_setup</a>(NULL);</div><div class="line"></div><div class="line">    xLoggingTaskInitialize(IOT_LOG_STACK_SIZE, 1, 10);</div><div class="line"></div><div class="line">    <span class="comment">/* Start up the network stack. */</span></div><div class="line">    FreeRTOS_IPInit(g_ip_address, g_net_mask, g_gateway_address, g_dns_address, g_mac_address);</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (pdFALSE == FreeRTOS_IsNetworkUp())</div><div class="line">    {</div><div class="line">        vTaskDelay(1);</div><div class="line">    }</div><div class="line"></div><div class="line">    Socket_t socket = SOCKETS_Socket(SOCKETS_AF_INET, SOCKETS_SOCK_STREAM, SOCKETS_IPPROTO_TCP);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (SOCKETS_INVALID_SOCKET == socket)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Could not create socket. */</span></div><div class="line">        __BKPT(0);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">const</span> IotNetworkServerInfo_t serverInfo =</div><div class="line">    {</div><div class="line">        .pHostName = <span class="stringliteral">&quot;192.168.0.100&quot;</span>,</div><div class="line">        .port      = 1883</div><div class="line">    };</div><div class="line"></div><div class="line">    IotSdk_Init();</div><div class="line"></div><div class="line">    RunMqttDemo(connect_to_aws, <span class="stringliteral">&quot;renesas-iot-demo&quot;</span>, (<span class="keywordtype">void</span> *) &amp;serverInfo, NULL, &amp;IotNetworkAfr);</div><div class="line">}</div><div class="line"></div></div><!-- fragment --> <h3>Secure connection to a Mosquitto server</h3>
<dl class="section note"><dt>Note</dt><dd>MbedTLS must be initialized and key provisioning must be done before starting a secure connection. Refer to <a class="el" href="group___a_w_s___s_e_c_u_r_e___s_o_c_k_e_t_s.html">AWS Secure Sockets</a>.</dd></dl>
<div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#define keyCLIENT_CERTIFICATE_PEM      \</span></div><div class="line"><span class="preprocessor">    &quot;-----BEGIN CERTIFICATE-----\n&quot;    \</span></div><div class="line"><span class="preprocessor">    &quot;example_certificate_formatting\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;-----END CERTIFICATE-----&quot;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define keyCLIENT_PRIVATE_KEY_PEM       \</span></div><div class="line"><span class="preprocessor">    &quot;-----BEGIN RSA PRIVATE KEY-----\n&quot; \</span></div><div class="line"><span class="preprocessor">    &quot;example_certificate_formatting\n&quot;  \</span></div><div class="line"><span class="preprocessor">    &quot;-----END RSA PRIVATE KEY-----&quot;</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> SERVER_CERTIFICATE_PEM[] = <span class="stringliteral">&quot;-----BEGIN CERTIFICATE-----\n&quot;</span></div><div class="line">                                       <span class="stringliteral">&quot;example_certificate_formatting\n&quot;</span></div><div class="line">                                       <span class="stringliteral">&quot;-----END CERTIFICATE-----&quot;</span>;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> CLIENT_CERTIFICATE_PEM[] = <span class="stringliteral">&quot;-----BEGIN CERTIFICATE-----\n&quot;</span></div><div class="line">                                       <span class="stringliteral">&quot;example_certificate_formatting\n&quot;</span></div><div class="line">                                       <span class="stringliteral">&quot;-----END CERTIFICATE-----&quot;</span>;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">char</span> CLIENT_KEY_PEM[] = <span class="stringliteral">&quot;-----BEGIN RSA PRIVATE KEY-----\n&quot;</span></div><div class="line">                               <span class="stringliteral">&quot;example_certificate_formatting\n&quot;</span></div><div class="line">                               <span class="stringliteral">&quot;-----END RSA PRIVATE KEY-----&quot;</span>;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> mqtt_secure_example ()</div><div class="line">{</div><div class="line">    <span class="keywordtype">bool</span> connect_to_aws = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* Initialize the crypto hardware acceleration. */</span></div><div class="line">    <a class="code" href="group___r_m___p_s_a___c_r_y_p_t_o.html#gaf0f37c11be234650bec95ce37e9a4a6b">mbedtls_platform_setup</a>(NULL);</div><div class="line"></div><div class="line">    xLoggingTaskInitialize(IOT_LOG_STACK_SIZE, 1, 10);</div><div class="line"></div><div class="line">    ProvisioningParams_t params;</div><div class="line"></div><div class="line">    <span class="comment">/* Write the keys into a secure region in data flash. */</span></div><div class="line">    params.pucClientPrivateKey       = (uint8_t *) keyCLIENT_PRIVATE_KEY_PEM;</div><div class="line">    params.pucClientCertificate      = (uint8_t *) keyCLIENT_CERTIFICATE_PEM;</div><div class="line">    params.ulClientPrivateKeyLength  = 1 + strlen((<span class="keyword">const</span> <span class="keywordtype">char</span> *) params.pucClientPrivateKey);</div><div class="line">    params.ulClientCertificateLength = 1 + strlen((<span class="keyword">const</span> <span class="keywordtype">char</span> *) params.pucClientCertificate);</div><div class="line">    params.pucJITPCertificate        = NULL;</div><div class="line">    params.ulJITPCertificateLength   = 0;</div><div class="line">    vAlternateKeyProvisioning(&amp;params);</div><div class="line"></div><div class="line">    <span class="comment">/* Start up the network stack. */</span></div><div class="line">    FreeRTOS_IPInit(g_ip_address, g_net_mask, g_gateway_address, g_dns_address, g_mac_address);</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (pdFALSE == FreeRTOS_IsNetworkUp())</div><div class="line">    {</div><div class="line">        vTaskDelay(1);</div><div class="line">    }</div><div class="line"></div><div class="line">    Socket_t socket = SOCKETS_Socket(SOCKETS_AF_INET, SOCKETS_SOCK_STREAM, SOCKETS_IPPROTO_TCP);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (SOCKETS_INVALID_SOCKET == socket)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Could not create socket. */</span></div><div class="line">        __BKPT(0);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">const</span> IotNetworkServerInfo_t serverInfo =</div><div class="line">    {</div><div class="line">        .pHostName = <span class="stringliteral">&quot;192.168.0.100&quot;</span>,</div><div class="line">        .port      = 8883</div><div class="line">    };</div><div class="line"></div><div class="line">    <span class="keyword">const</span> IotNetworkCredentials_t afrCredentials =</div><div class="line">    {</div><div class="line">        .pAlpnProtos       = NULL,</div><div class="line">        .maxFragmentLength = 1400,</div><div class="line">        .disableSni        = <span class="keyword">true</span>,</div><div class="line">        .pRootCa           = SERVER_CERTIFICATE_PEM,</div><div class="line">        .rootCaSize        = <span class="keyword">sizeof</span>(SERVER_CERTIFICATE_PEM),</div><div class="line">        .pClientCert       = CLIENT_CERTIFICATE_PEM,</div><div class="line">        .clientCertSize    = <span class="keyword">sizeof</span>(CLIENT_CERTIFICATE_PEM),</div><div class="line">        .pPrivateKey       = CLIENT_KEY_PEM,</div><div class="line">        .privateKeySize    = <span class="keyword">sizeof</span>(CLIENT_KEY_PEM),</div><div class="line">    };</div><div class="line"></div><div class="line">    IotSdk_Init();</div><div class="line"></div><div class="line">    RunMqttDemo(connect_to_aws, <span class="stringliteral">&quot;renesas-iot-demo&quot;</span>, (<span class="keywordtype">void</span> *) &amp;serverInfo, (<span class="keywordtype">void</span> *) &amp;afrCredentials, &amp;IotNetworkAfr);</div><div class="line">}</div><div class="line"></div></div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.7-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
        <li class="footer">FSP Release v2.4.0 User's Manual Copyright © (2021) Renesas Electronics Corporation. All Rights Reserved.</li>
  </ul>
</div>
</body>
</html>
